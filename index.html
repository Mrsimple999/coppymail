<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quản lý Email Online - One Device Lock</title>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<style>
body { font-family: sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; transition: background 0.4s; }
textarea, input, button { font-size: 16px; width: 90%; max-width: 340px; margin-top: 10px; padding: 12px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; }
button { background: #007bff; color: white; border: none; cursor: pointer; transition: background 0.3s; }
button:hover { background: #0056b3; }
.input-container { display: flex; gap: 10px; align-items: center; width: 90%; max-width: 340px; margin-top: 10px; }
#manualCopyButton { max-width: 60px; padding: 10px; }
#deleteListButton { background: #dc3545; }
#deleteListButton:hover { background: #a71d2a; }
#copyButton { font-size: 20px; padding: 18px; width: 95%; max-width: 380px; margin-top: 30px; background: #28a745; }
#copyButton:hover { background: #1c7c31; }
</style>
</head>
<body>
<h3>📨 Quản lý danh sách Email Online (One Device Lock)</h3>
<textarea id="emailListInput" placeholder="Dán email tại đây"></textarea>
<button id="addListButton">➕ Thêm Email</button>
<button id="deleteListButton">🗑️ Xóa Danh Sách</button>
<div class="input-container">
<input type="text" id="emailOutput" placeholder="Email sẽ hiển thị ở đây" readonly>
<button id="manualCopyButton">📋</button>
</div>
<p id="count"></p>
<p id="output"></p>
<button id="copyButton">📋 Lấy & Copy Email</button>
<script>
const firebaseConfig = { /* config của bạn */ };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const emailRef = db.ref('emails');
const lockRef = db.ref('lock');
let emailList = [];
function extractEmails(text) {
    const separators = /[\s,;|]+/;
    const parts = text.split(separators);
    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    const emailSet = new Set();
    parts.forEach(item => { if (emailRegex.test(item.trim())) emailSet.add(item.trim().toLowerCase()); });
    return Array.from(emailSet);
}
function updateCount() { document.getElementById('count').textContent = `📊 Số email: ${emailList.length}`; }
emailRef.on('value', snap => { emailList = snap.val() || []; updateCount(); });
document.getElementById('addListButton').addEventListener('click', () => {
    const filtered = extractEmails(document.getElementById('emailListInput').value);
    if (!filtered.length) { document.getElementById('output').textContent = '⚠️ Không có email hợp lệ.'; return; }
    emailRef.transaction(list => { list = list || []; filtered.forEach(e => { if (!list.includes(e)) list.push(e); }); return list; }, () => { document.getElementById('emailListInput').value = ''; updateCount(); document.getElementById('output').textContent = `✅ Đã thêm ${filtered.length} email.`; });
});
document.getElementById('deleteListButton').addEventListener('click', () => {
    if (confirm('Bạn có chắc muốn xóa toàn bộ?')) emailRef.set([]);
});
document.getElementById('manualCopyButton').addEventListener('click', () => {
    const email = document.getElementById('emailOutput').value;
    if (!email) { document.getElementById('output').textContent = '⚠️ Không có email để copy.'; return; }
    navigator.clipboard.writeText(email);
    document.getElementById('output').textContent = `✅ Đã copy: ${email}`;
});
document.getElementById('copyButton').addEventListener('click', () => {
    document.body.style.background = '#17a2b8';
    lockRef.transaction(current => {
        if (current) return; // đã có thiết bị khác lấy
        return true;
    }, (error, committed) => {
        if (!committed) {
            document.getElementById('output').textContent = '⚠️ Email đã được lấy bởi thiết bị khác.';
            return;
        }
        if (emailList.length === 0) {
            document.getElementById('output').textContent = '✅ Danh sách đã hết email.';
            lockRef.remove();
            return;
        }
        const index = Math.floor(Math.random() * emailList.length);
        const email = emailList[index];
        navigator.clipboard.writeText(email);
        document.getElementById('emailOutput').value = email;
        emailRef.transaction(list => { if (!list) return []; list.splice(index, 1); return list; }, () => {
            document.getElementById('output').textContent = `✅ Đã copy: ${email}`;
            updateCount();
        });
    });
});
</script>
</body>
</html>
