<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Quản lý Email – Đồng bộ đa thiết bị</title>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<style>
  body { font-family: sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; transition: background 0.4s; }
  textarea, input, button { font-size: 16px; width: 90%; max-width: 340px; margin-top: 10px; padding: 12px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; }
  button { background: #007bff; color: white; border: none; cursor: pointer; transition: background 0.3s; }
  button:hover { background: #0056b3; }
  #copyButton { font-size: 20px; padding: 18px; width: 95%; background: #28a745; margin-top: 30px; }
  #copyButton:hover { background: #1c7c31; }
</style>
</head>
<body>

<h3>📨 Quản lý Email – Đồng bộ đa thiết bị</h3>
<textarea id="emailInput" placeholder="Dán email (|; , space...)" ></textarea>
<button id="addBtn">➕ Thêm Email</button>
<button id="deleteBtn">🗑️ Xóa toàn bộ</button>

<input id="emailOut" readonly placeholder="Email xuất hiện ở đây" style="margin-top:10px; width:90%; max-width:340px;"/>
<button id="copyBtn" style="margin-top:10px;">📋 Copy Thủ Công</button>

<p id="count"></p>
<p id="msg"></p>

<button id="copyButton">📋 Lấy & Copy Email</button>

<script>
// Firebase config
const firebaseConfig = { /* cấu hình của bạn */ };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const emailsRef = db.ref('emails');
const takenRef = db.ref('takenEmails');

// UID thiết bị riêng
const deviceUID = localStorage.getItem('device_uid') || crypto.randomUUID();
localStorage.setItem('device_uid', deviceUID);

let emailList = [];

function extractEmails(txt) {
  const parts = txt.split(/[\s,;|]+/);
  return [...new Set(parts.map(s => s.trim().toLowerCase()).filter(e => /^[\w.+-]+@[A-Za-z\d.-]+\.[A-Za-z]{2,}$/.test(e)))];
}

function updateCount() {
  document.getElementById('count').textContent = `📊 Số email còn lại: ${emailList.length}`;
}

function copyText(txt) {
  navigator.clipboard.writeText(txt).then(() => {
    document.getElementById('msg').textContent = `✅ Đã copy: ${txt}`;
  });
}

// Load danh sách realtime
emailsRef.on('value', snap => {
  emailList = snap.val() || [];
  updateCount();
});

// Thêm
document.getElementById('addBtn').onclick = () => {
  const arr = extractEmails(document.getElementById('emailInput').value);
  if (!arr.length) { document.getElementById('msg').textContent = '⚠️ Không có email hợp lệ'; return; }
  emailsRef.transaction(list => {
    const a = list ? [...list] : [];
    arr.forEach(e => a.includes(e) || a.push(e));
    return a;
  });
  document.getElementById('emailInput').value = '';
};

// Xóa toàn bộ
document.getElementById('deleteBtn').onclick = () => {
  if (confirm('Xóa toàn bộ?')) emailsRef.set([]);
};

// Copy thủ công
document.getElementById('copyBtn').onclick = () => {
  const e = document.getElementById('emailOut').value;
  if (e) copyText(e);
};

// Lấy & Copy ngẫu nhiên
document.getElementById('copyButton').onclick = () => {
  const btn = document.getElementById('copyButton');
  btn.disabled = true; btn.textContent = '⏳ Đang xử lý...';
  document.body.style.background = '#17a2b8';

  if (!emailList.length) {
    document.getElementById('msg').textContent = '✅ Danh sách đã hết email.';
    resetUI();
    return;
  }

  const idx = Math.floor(Math.random() * emailList.length);
  const email = emailList[idx];
  const node = takenRef.child(encodeURIComponent(email));

  node.once('value').then(snap => {
    const by = snap.val();
    if (by && by !== deviceUID) {
      document.body.style.background = '#ffc107';
      document.getElementById('msg').textContent = `⚠️ Email đã bị lấy bởi thiết bị khác (UID: ${by})`;
      btn.disabled = false; btn.textContent = '📋 Lấy & Copy Email';
      return;
    }

    node.set(deviceUID).then(() => {
      copyText(email);
      setTimeout(() => {
        emailsRef.transaction(list => {
          if (!list) return [];
          const i = list.indexOf(email);
          if (i >= 0) list.splice(i,1);
          return list;
        }, (err, com, snap2) => {
          if (com) {
            emailList = snap2.val() || [];
            updateCount();
            document.getElementById('emailOut').value = email;
            document.getElementById('msg').textContent = `✅ Đã lấy email: ${email}`;
          }
          node.remove();
          resetUI();
        });
      }, 500);
    });
  });
};

function resetUI() {
  const btn = document.getElementById('copyButton');
  btn.disabled = false; btn.textContent = '📋 Lấy & Copy Email';
  if (document.body.style.background !== 'rgb(255, 193, 7)') {
    document.body.style.background = '#f0f2f5';
  }
}
</script>
</body>
</html>
🧪 Cách kiểm thử đa thiết bị:
Mở file trên 2 tab (hoặc 2 máy khác nhau).

Nhấn Lấy & Copy Email gần như cùng lúc:

Tab nào thực hiện nhanh nhất sẽ lấy email về, xóa mục đó.

Tab còn lại sẽ hiển thị nền vàng + cảnh báo UID.

⚠️ UID không bị lộ ra người dùng, chỉ dùng để phân biệt thiết bị, tự sinh trong localStorage và xóa sau khi xong.

Nếu cần bao gồm Telegram, thống kê, hoặc muốn đóng gói hoàn chỉnh .html, zip, cứ nói nhé!



Bạn đã nói:
lấy mail cứ bị đang xử lý

ChatGPT đã nói:
Bạn bị "Đang xử lý..." mãi vì đoạn code chờ takenRef.set(deviceUID) hoặc transaction xóa email chưa thành công hoặc không gọi resetUI() đúng lúc, hoặc do lỗi bất đồng bộ.

Mình đã rà soát lại và tối ưu lại đoạn copyButton xử lý:

Thêm nhiều catch để bắt lỗi.

Đảm bảo mọi nhánh đều gọi resetUI() trả lại trạng thái button và màu nền.

Thêm console.log để dễ debug.

Bạn thay đoạn xử lý nút "Lấy & Copy Email" trong script bằng đoạn này nhé:

js
Sao chép
Chỉnh sửa
document.getElementById('copyButton').onclick = () => {
  const btn = document.getElementById('copyButton');
  btn.disabled = true; 
  btn.textContent = '⏳ Đang xử lý...';
  document.body.style.background = '#17a2b8';

  if (!emailList.length) {
    document.getElementById('msg').textContent = '✅ Danh sách đã hết email.';
    resetUI();
    return;
  }

  const idx = Math.floor(Math.random() * emailList.length);
  const email = emailList[idx];
  const node = takenRef.child(encodeURIComponent(email));

  node.once('value').then(snap => {
    const by = snap.val();
    if (by && by !== deviceUID) {
      document.body.style.background = '#ffc107';
      document.getElementById('msg').textContent = `⚠️ Email đã bị lấy bởi thiết bị khác (UID: ${by})`;
      resetUI();
      return Promise.reject('Email đã bị lấy');
    }

    return node.set(deviceUID).then(() => {
      copyText(email);
      return new Promise(resolve => setTimeout(resolve, 500));
    }).then(() => {
      return emailsRef.transaction(list => {
        if (!list) return [];
        const i = list.indexOf(email);
        if (i >= 0) list.splice(i, 1);
        return list;
      });
    }).then((result) => {
      const [error, committed, snap2] = result;
      if (committed) {
        emailList = snap2.val() || [];
        updateCount();
        document.getElementById('emailOut').value = email;
        document.getElementById('msg').textContent = `✅ Đã lấy email: ${email}`;
      }
      return node.remove();
    });
  }).catch(err => {
    if (err !== 'Email đã bị lấy') {
      console.error('Lỗi:', err);
      document.getElementById('msg').textContent = '⚠️ Có lỗi xảy ra khi lấy email.';
    }
  }).finally(() => {
    resetUI();
  });
};

function resetUI() {
  const btn = document.getElementById('copyButton');
  btn.disabled = false; 
  btn.textContent = '📋 Lấy & Copy Email';
  if (document.body.style.background !== 'rgb(255, 193, 7)') {
    document.body.style.background = '#f0f2f5';
  }
}
